/**
 * 传感器仪表板 - 时间轴优化版本
 */

class SensorDashboard {
    constructor() {
        // 配置常量
        this.config = {
            autoRefreshInterval: 10000,
            fetchRetries: 3,
            fetchBaseDelay: 500,
            chartRefreshProbability: 0.1,
            recordCountUpdateInterval: 30000,
            defaultHours: {
                co2: 24,
                tempHumi: 24
            },
            // 图表范围配置
            chartRanges: {
                fixed: {
                    temperature: { min: 10, max: 35 },
                    humidity: { min: 20, max: 90 },
                    co2: { min: 400, max: 2000 }
                }
            }
        };

        // 状态管理
        this.state = {
            autoRefreshEnabled: false,
            autoRefreshTimer: null,
            charts: {
                co2: null,
                tempHumi: null
            },
            currentHours: {
                co2: this.config.defaultHours.co2,
                tempHumi: this.config.defaultHours.tempHumi
            }
        };

        this.elements = {};
        this.init();
    }

    init() {
        this.cacheElements();
        this.initCharts();
        this.bindEvents();
        this.loadInitialData();
        this.startAutoRefresh();
        this.startPeriodicTasks();
        
        console.log('传感器仪表板初始化完成');
    }

    cacheElements() {
        const selectors = {
            co2Value: '#co2Value',
            tempValue: '#tempValue',
            humiValue: '#humiValue',
            scd40Status: '#scd40Status',
            dht22Status: '#dht22Status',
            lastUpdatedTime: '#lastUpdatedTime',
            localTime: '#localTime',
            errorMessage: '#errorMessage',
            errorText: '#errorText',
            refreshBtn: '#refreshBtn',
            autoRefreshToggle: '#autoRefreshToggle',
            refreshAllCharts: '#refreshAllCharts',
            recordCount: '#recordCount',
            co2Min: '#co2Min',
            co2Max: '#co2Max',
            co2Source: '#co2Source',
            tempRange: '#tempRange',
            humiRange: '#humiRange',
            co2TimeButtons: '[data-chart="co2"].time-btn',
            tempHumiTimeButtons: '[data-chart="temp_humi"].time-btn'
        };

        Object.keys(selectors).forEach(key => {
            if (key.includes('Buttons')) {
                this.elements[key] = document.querySelectorAll(selectors[key]);
            } else {
                this.elements[key] = document.querySelector(selectors[key]);
            }
        });

        this.updateTimeDisplays();
    }

    updateTimeDisplays() {
        const now = new Date();
        
        if (this.elements.localTime) {
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            this.elements.localTime.textContent = 
                `时间: ${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    }

    initCharts() {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js未加载，图表功能已禁用');
            this.showError('图表功能已禁用：Chart.js未加载。请检查static/vendor目录下的chart.min.js文件。');
            return;
        }

        try {
            this.initCo2Chart();
            this.initTempHumiChart();
            console.log('图表初始化完成');
        } catch (error) {
            console.error('图表初始化失败:', error);
            this.showError('图表初始化失败，请刷新页面重试');
        }
    }

    /**
     * 初始化CO2图表 - 使用时间轴
     */
    initCo2Chart() {
        const canvas = document.getElementById('co2Chart');
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

        this.state.charts.co2 = new Chart(canvas, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'CO₂浓度',
                    data: [],
                    borderColor: 'rgb(76, 201, 240)',
                    backgroundColor: 'rgba(76, 201, 240, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: this.getChartOptions('co2')
        });
    }

    /**
     * 初始化温湿度图表 - 使用时间轴
     */
    initTempHumiChart() {
        const canvas = document.getElementById('tempHumiChart');
        if (!canvas) return;

        const existingChart = Chart.getChart(canvas);
        if (existingChart) {
            existingChart.destroy();
        }

        this.state.charts.tempHumi = new Chart(canvas, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: '温度',
                        data: [],
                        borderColor: 'rgb(247, 37, 133)',
                        backgroundColor: 'rgba(247, 37, 133, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        yAxisID: 'y'
                    },
                    {
                        label: '湿度',
                        data: [],
                        borderColor: 'rgb(74, 214, 109)',
                        backgroundColor: 'rgba(74, 214, 109, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: this.getChartOptions('tempHumi')
        });
    }

    /**
     * 获取图表配置选项 - 使用时间轴
     */
    getChartOptions(type) {
        const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'rgba(255, 255, 255, 0.9)',
                    bodyColor: 'rgba(255, 255, 255, 0.8)',
                    padding: 10,
                    cornerRadius: 4,
                    displayColors: true,
                    callbacks: {
                        title: function(tooltipItems) {
                            if (tooltipItems.length > 0) {
                                const date = new Date(tooltipItems[0].parsed.x);
                                return date.toLocaleString('zh-CN', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit'
                                });
                            }
                            return '';
                        }
                    }
                }
            },
            animation: {
                duration: 300
            }
        };

        // X轴配置 - 使用时间轴
        const scales = {
            x: {
                type: 'time',
                time: {
                    tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                    displayFormats: {
                        millisecond: 'HH:mm:ss.SSS',
                        second: 'HH:mm:ss',
                        minute: 'HH:mm',
                        hour: 'HH:mm',
                        day: 'MM-dd',
                        week: 'MM-dd',
                        month: 'yyyy-MM',
                        quarter: 'yyyy-MM',
                        year: 'yyyy'
                    }
                },
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.6)',
                    maxRotation: 45,
                    minRotation: 45,
                    maxTicksLimit: 12 // 最多显示12个时间标签
                },
                title: {
                    display: true,
                    text: '时间',
                    color: 'rgba(255, 255, 255, 0.8)'
                }
            }
        };

        // Y轴配置
        if (type === 'co2') {
            scales.y = {
                type: 'linear',
                display: true,
                position: 'left',
                min: this.config.chartRanges.fixed.co2.min,
                max: this.config.chartRanges.fixed.co2.max,
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.6)',
                    callback: function(value) {
                        return value + ' ppm';
                    }
                },
                title: {
                    display: true,
                    text: 'CO₂浓度 (ppm)',
                    color: 'rgba(255, 255, 255, 0.8)'
                }
            };
        } else if (type === 'tempHumi') {
            scales.y = {
                type: 'linear',
                display: true,
                position: 'left',
                min: this.config.chartRanges.fixed.temperature.min,
                max: this.config.chartRanges.fixed.temperature.max,
                grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.6)',
                    callback: function(value) {
                        return value + '°C';
                    }
                },
                title: {
                    display: true,
                    text: '温度 (°C)',
                    color: 'rgba(255, 255, 255, 0.8)'
                }
            };

            scales.y1 = {
                type: 'linear',
                display: true,
                position: 'right',
                min: this.config.chartRanges.fixed.humidity.min,
                max: this.config.chartRanges.fixed.humidity.max,
                grid: {
                    drawOnChartArea: false
                },
                ticks: {
                    color: 'rgba(255, 255, 255, 0.6)',
                    callback: function(value) {
                        return value + '%';
                    }
                },
                title: {
                    display: true,
                    text: '湿度 (%)',
                    color: 'rgba(255, 255, 255, 0.8)'
                }
            };
        }

        baseOptions.scales = scales;
        return baseOptions;
    }

    /**
     * 转换数据为时间轴格式
     */
    convertToTimeSeriesData(data, hours) {
        if (!data.labels || !Array.isArray(data.labels)) {
            return data;
        }
        
        const result = {
            datasets: []
        };
        
        // 获取当前时间作为参考
        const now = new Date();
        
        // 转换标签为时间戳
        const timeLabels = data.labels.map((label, index) => {
            try {
                // 尝试解析不同的时间格式
                if (hours <= 24) {
                    // 格式: "HH:mm"
                    const [hoursStr, minutesStr] = label.split(':');
                    const date = new Date(now);
                    date.setHours(parseInt(hoursStr), parseInt(minutesStr), 0, 0);
                    
                    // 如果时间在未来，则调整为昨天
                    if (date > now) {
                        date.setDate(date.getDate() - 1);
                    }
                    
                    return date;
                } else {
                    // 格式: "MM-DD HH:mm"
                    const [dateStr, timeStr] = label.split(' ');
                    const [monthStr, dayStr] = dateStr.split('-');
                    const [hoursStr, minutesStr] = timeStr.split(':');
                    
                    const date = new Date(now.getFullYear(), 
                                        parseInt(monthStr) - 1, 
                                        parseInt(dayStr),
                                        parseInt(hoursStr), 
                                        parseInt(minutesStr), 0, 0);
                    
                    return date;
                }
            } catch (error) {
                // 如果解析失败，使用相对时间
                console.warn('时间标签解析失败:', error, label);
                const offset = (data.labels.length - index - 1) * (hours * 3600000 / data.labels.length);
                return new Date(now.getTime() - offset);
            }
        });
        
        // 转换数据集
        if (data.datasets && Array.isArray(data.datasets)) {
            result.datasets = data.datasets.map((dataset, datasetIndex) => {
                const timeSeriesData = [];
                
                for (let i = 0; i < Math.min(timeLabels.length, dataset.data.length); i++) {
                    timeSeriesData.push({
                        x: timeLabels[i],
                        y: dataset.data[i]
                    });
                }
                
                return {
                    ...dataset,
                    data: timeSeriesData
                };
            });
        }
        
        return result;
    }

    bindEvents() {
        if (this.elements.refreshBtn) {
            this.elements.refreshBtn.addEventListener('click', () => {
                this.fetchSensorData();
            });
        }

        if (this.elements.autoRefreshToggle) {
            this.elements.autoRefreshToggle.addEventListener('click', () => {
                this.toggleAutoRefresh();
            });
        }

        if (this.elements.refreshAllCharts) {
            this.elements.refreshAllCharts.addEventListener('click', () => {
                this.refreshAllCharts();
            });
        }

        if (this.elements.co2TimeButtons) {
            this.elements.co2TimeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    this.handleTimeButtonClick(button, 'co2');
                });
            });
        }

        if (this.elements.tempHumiTimeButtons) {
            this.elements.tempHumiTimeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    this.handleTimeButtonClick(button, 'tempHumi');
                });
            });
        }

        // 窗口大小变化时调整图表
        window.addEventListener('resize', () => {
            this.debounce(() => {
                if (this.state.charts.co2) this.state.charts.co2.resize();
                if (this.state.charts.tempHumi) this.state.charts.tempHumi.resize();
            }, 250);
        });
    }

    handleTimeButtonClick(button, chartType) {
        const buttonGroup = chartType === 'co2' 
            ? this.elements.co2TimeButtons 
            : this.elements.tempHumiTimeButtons;
        
        buttonGroup.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        const hours = parseInt(button.dataset.hours) || this.config.defaultHours[chartType];
        this.state.currentHours[chartType] = hours;

        this.fetchChartData(chartType, hours);
    }

    async loadInitialData() {
        try {
            await Promise.all([
                this.fetchSensorData(),
                this.fetchChartData('co2', this.state.currentHours.co2),
                this.fetchChartData('tempHumi', this.state.currentHours.tempHumi),
                this.fetchRecordCount()
            ]);
        } catch (error) {
            console.error('加载初始数据失败:', error);
            this.showError('加载初始数据失败，请刷新页面重试');
        }
    }

    startPeriodicTasks() {
        setInterval(() => {
            this.updateTimeDisplays();
        }, 60000);

        setInterval(() => {
            this.fetchRecordCount();
        }, this.config.recordCountUpdateInterval);
    }

    async fetchSensorData(showLoading = true) {
        try {
            if (showLoading && this.elements.refreshBtn) {
                this.elements.refreshBtn.classList.add('loading');
            }

            const data = await this.fetchWithRetry('/api/environment');

            // 更新传感器数据
            if (this.elements.co2Value) {
                const co2 = data.sensors?.scd40?.co2;
                this.elements.co2Value.textContent = co2 !== null && co2 !== undefined ? co2 : '--';
            }

            if (this.elements.tempValue) {
                const temp = data.sensors?.dht22?.temperature;
                this.elements.tempValue.textContent = temp !== null && temp !== undefined ? temp : '--';
            }

            if (this.elements.humiValue) {
                const humi = data.sensors?.dht22?.humidity;
                this.elements.humiValue.textContent = humi !== null && humi !== undefined ? humi : '--';
            }

            // 更新传感器状态
            this.updateSensorStatus(data);

            // 更新最后更新时间
            this.updateLastUpdatedTime(data);

            this.hideError();
            return data;
        } catch (error) {
            console.error('获取传感器数据失败:', error);
            this.showError(`传感器连接失败: ${error.message || '网络错误'}`);
            throw error;
        } finally {
            if (this.elements.refreshBtn) {
                this.elements.refreshBtn.classList.remove('loading');
            }
        }
    }

    updateSensorStatus(data) {
        // SCD40状态
        if (this.elements.scd40Status) {
            const status = data.sensors?.scd40?.status || 'offline';
            const statusConfig = {
                online: { className: 'status-item status-online', icon: 'fa-check-circle', text: '在线' },
                degraded: { className: 'status-item status-degraded', icon: 'fa-exclamation-circle', text: '降级' },
                offline: { className: 'status-item status-offline', icon: 'fa-times-circle', text: '离线' }
            };
            const config = statusConfig[status] || statusConfig.offline;
            this.elements.scd40Status.className = config.className;
            this.elements.scd40Status.innerHTML = `<i class="fas ${config.icon}"></i> SCD40: ${config.text}`;
        }

        // DHT22状态
        if (this.elements.dht22Status) {
            const status = data.sensors?.dht22?.status || 'offline';
            const statusConfig = {
                online: { className: 'status-item status-online', icon: 'fa-check-circle', text: '在线' },
                degraded: { className: 'status-item status-degraded', icon: 'fa-exclamation-circle', text: '降级' },
                offline: { className: 'status-item status-offline', icon: 'fa-times-circle', text: '离线' }
            };
            const config = statusConfig[status] || statusConfig.offline;
            this.elements.dht22Status.className = config.className;
            this.elements.dht22Status.innerHTML = `<i class="fas ${config.icon}"></i> DHT22: ${config.text}`;
        }
    }

    updateLastUpdatedTime(data) {
        if (!this.elements.lastUpdatedTime) return;

        const tzOffset = window.SERVER_TZ_OFFSET || 8;
        
        try {
            if (data.timestamp) {
                const date = new Date(data.timestamp * 1000);
                const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
                const localTime = new Date(utc + (tzOffset * 3600000));
                
                const timeString = localTime.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                this.elements.lastUpdatedTime.textContent = timeString;
            }
        } catch (error) {
            console.warn('时间格式化失败:', error);
            this.elements.lastUpdatedTime.textContent = '--';
        }
    }

    async fetchChartData(chartType, hours) {
        try {
            const endpoint = chartType === 'co2' 
                ? '/api/chart/co2' 
                : '/api/chart/temperature_humidity';
            
            const url = `${endpoint}?hours=${hours}`;
            const data = await this.fetchWithRetry(url);

            if (!data.success) {
                throw new Error('API返回失败状态');
            }

            this.updateChart(chartType, data);
            this.hideError();
            
            return data;
        } catch (error) {
            console.error(`获取${chartType}图表数据失败:`, error);
            this.showError(`无法获取${chartType === 'co2' ? 'CO₂' : '温湿度'}图表数据`);
            throw error;
        }
    }

    updateChart(chartType, data) {
        const chart = this.state.charts[chartType];
        if (!chart) return;

        // 转换为时间序列数据
        const timeSeriesData = this.convertToTimeSeriesData(data, this.state.currentHours[chartType]);
        
        // 更新图表数据
        chart.data = timeSeriesData;
        
        // 更新图表统计信息
        this.updateChartStats(chartType, data);
        
        // 更新图表显示
        chart.update();
    }

    updateChartStats(chartType, data) {
        if (chartType === 'co2') {
            if (data.range && this.elements.co2Min && this.elements.co2Max) {
                const { min, max } = data.range;
                this.elements.co2Min.textContent = min ? `${min.toFixed(0)} ppm` : '--';
                this.elements.co2Max.textContent = max ? `${max.toFixed(0)} ppm` : '--';
            }
            
            if (this.elements.co2Source) {
                this.elements.co2Source.textContent = data.source || 'SCD40';
            }
        } else if (chartType === 'tempHumi') {
            // 可以在这里添加温湿度统计信息的更新
        }
    }

    async fetchRecordCount() {
        try {
            const response = await fetch('/api/stats');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            if (data.success && this.elements.recordCount) {
                const count = data.stats?.total_records || 0;
                this.elements.recordCount.textContent = count.toLocaleString();
            }
        } catch (error) {
            console.warn('获取记录数量失败:', error);
        }
    }

    async fetchWithRetry(url, options = {}) {
        let lastError;

        for (let attempt = 0; attempt < this.config.fetchRetries; attempt++) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                lastError = error;

                if (attempt < this.config.fetchRetries - 1) {
                    const delay = this.config.fetchBaseDelay * Math.pow(2, attempt);
                    await this.sleep(delay);
                }
            }
        }

        throw lastError;
    }

    startAutoRefresh() {
        this.stopAutoRefresh();
        
        this.state.autoRefreshTimer = setInterval(() => {
            this.autoRefreshCycle();
        }, this.config.autoRefreshInterval);
        
        this.state.autoRefreshEnabled = true;
        this.updateAutoRefreshButton();
    }

    stopAutoRefresh() {
        if (this.state.autoRefreshTimer) {
            clearInterval(this.state.autoRefreshTimer);
            this.state.autoRefreshTimer = null;
        }
        
        this.state.autoRefreshEnabled = false;
        this.updateAutoRefreshButton();
    }

    toggleAutoRefresh() {
        if (this.state.autoRefreshEnabled) {
            this.stopAutoRefresh();
        } else {
            this.startAutoRefresh();
        }
    }

    updateAutoRefreshButton() {
        if (!this.elements.autoRefreshToggle) return;

        if (this.state.autoRefreshEnabled) {
            this.elements.autoRefreshToggle.innerHTML = '<i class="fas fa-pause"></i> 停止自动刷新';
            this.elements.autoRefreshToggle.classList.add('active');
        } else {
            this.elements.autoRefreshToggle.innerHTML = '<i class="fas fa-play"></i> 自动刷新 (10秒)';
            this.elements.autoRefreshToggle.classList.remove('active');
        }
    }

    autoRefreshCycle() {
        this.fetchSensorData(false);
        
        // 概率性刷新图表
        if (Math.random() < this.config.chartRefreshProbability) {
            this.refreshAllCharts();
        }
    }

    refreshAllCharts() {
        if (this.state.charts.co2) {
            this.fetchChartData('co2', this.state.currentHours.co2);
        }
        
        if (this.state.charts.tempHumi) {
            this.fetchChartData('tempHumi', this.state.currentHours.tempHumi);
        }
    }

    showError(message) {
        if (!this.elements.errorMessage || !this.elements.errorText) return;

        this.elements.errorText.textContent = message;
        this.elements.errorMessage.style.display = 'block';

        setTimeout(() => {
            this.hideError();
        }, 5000);
    }

    hideError() {
        if (this.elements.errorMessage) {
            this.elements.errorMessage.style.display = 'none';
        }
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// 页面加载完成后初始化仪表板
document.addEventListener('DOMContentLoaded', () => {
    try {
        const dashboard = new SensorDashboard();
        window.sensorDashboard = dashboard;
        
        // 检查Chart.js和适配器是否加载
        setTimeout(() => {
            if (typeof Chart === 'undefined') {
                const fallbackElement = document.getElementById('vendorFallback');
                if (fallbackElement) {
                    fallbackElement.style.display = 'block';
                }
            }
        }, 1000);
        
    } catch (error) {
        console.error('仪表板初始化失败:', error);
        alert('仪表板初始化失败，请刷新页面重试');
    }
});