#!/bin/bash
# Git预推送钩子 - 检查推送环境

echo "🔍 检查推送环境..."

# 检查是否在VSCode中运行
if [ -z "$VSCODE_IPC_HOOK_CLI" ] && [ "$TERM_PROGRAM" != "vscode" ]; then
    echo "❌ 错误：检测到非VSCode环境推送"
    echo ""
    echo "📌 安全策略："
    echo "   所有Git推送操作必须在VSCode中进行"
    echo "   这是为了防止版本冲突和分支混乱"
    echo ""
    echo "✅ 正确操作："
    echo "   1. 在VSCode中打开「源代码管理」面板"
    echo "   2. 点击「...」菜单"
    echo "   3. 选择「推送」选项"
    echo ""
    exit 1
fi

# 检查是否需要先拉取
echo "📡 检查远程更新..."
git fetch origin

LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})

if [ $LOCAL != $REMOTE ]; then
    echo "⚠️  警告：远程有新的提交"
    echo ""
    echo "建议操作："
    echo "   1. 先点击「拉取」获取最新代码"
    echo "   2. 解决可能的冲突"
    echo "   3. 再次尝试推送"
    echo ""
    read -p "是否继续推送？(y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "✅ 推送检查通过"
exit 0
